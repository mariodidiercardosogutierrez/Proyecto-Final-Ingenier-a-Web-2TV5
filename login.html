<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar Sesión - Music Store</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body style="display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; background:#b30000;">
    <div class="login-card">
        <h2>Iniciar Sesión</h2>
        <form id="loginForm">
            <div class="input-group">
                <label for="email">Correo electrónico</label>
                <input type="email" id="email" required />
            </div>
            <div class="input-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" required />
            </div>
            <button type="submit" class="btn">Entrar</button>
        </form>


        <p class="register-text">
            ¿No tienes cuenta? <a href="register.html" class="register-link">Regístrate</a>
        </p>
    </div>

    <script src="main.js"></script>
    <!-- login.html - Agregar este script antes del cierre de body -->
<script>
<!-- En login.html, reemplaza todo el script con este: -->

// Función para limpiar datos de sesión previa pero no todo
function cleanPreviousSession() {
    // Guardar algunos datos que podrían ser necesarios
    const rememberMe = localStorage.getItem('rememberMe');
    const lastLoginEmail = localStorage.getItem('lastLoginEmail');
    
    // Limpiar solo datos de sesión
    const itemsToKeep = ['rememberMe', 'lastLoginEmail', 'language', 'theme'];
    const allItems = Object.keys(localStorage);
    
    allItems.forEach(key => {
        if (!itemsToKeep.includes(key)) {
            localStorage.removeItem(key);
        }
    });
    
    // Restaurar datos guardados
    if (lastLoginEmail) {
        document.getElementById('email').value = lastLoginEmail;
    }
}

// Función para detectar navegador
function getBrowserInfo() {
    const ua = navigator.userAgent;
    let browser = "unknown";
    
    if (ua.includes("Chrome") && !ua.includes("Edg")) browser = "chrome";
    else if (ua.includes("Firefox")) browser = "firefox";
    else if (ua.includes("Safari") && !ua.includes("Chrome")) browser = "safari";
    else if (ua.includes("Edg")) browser = "edge";
    
    return browser;
}

// Función para verificar compatibilidad de localStorage
function isLocalStorageAvailable() {
    try {
        const test = '__storage_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
    } catch(e) {
        console.warn('LocalStorage no disponible:', e);
        return false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const submitBtn = loginForm.querySelector('.btn');
    
    // Detectar navegador
    const browser = getBrowserInfo();
    console.log('Navegador detectado:', browser);
    
    // Verificar localStorage
    if (!isLocalStorageAvailable()) {
        alert('Tu navegador no soporta almacenamiento local. Algunas funciones pueden no estar disponibles.');
    }
    
    // Limpiar sesión previa al cargar la página de login
    cleanPreviousSession();
    
    // Verificar si ya hay una sesión activa (solo si es reciente)
    const lastLoginTime = localStorage.getItem('lastLoginTime');
    const userRole = localStorage.getItem('userRole');
    const userEmail = localStorage.getItem('userEmail');
    
    // Si la sesión es de hace menos de 1 hora, redirigir automáticamente
    if (lastLoginTime && userRole && userEmail) {
        const sessionAge = Date.now() - parseInt(lastLoginTime);
        const oneHour = 60 * 60 * 1000;
        
        if (sessionAge < oneHour) {
            if (userRole === 'admin') {
                window.location.href = 'a_index.html';
            } else {
                window.location.href = 'index.html';
            }
            return;
        } else {
            // Sesión expirada, limpiar
            localStorage.removeItem('lastLoginTime');
        }
    }
    
    // Restaurar email si existe en el campo
    const savedEmail = localStorage.getItem('savedEmail');
    if (savedEmail && emailInput) {
        emailInput.value = savedEmail;
    }
    
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = emailInput.value.trim();
        const password = passwordInput.value;

        if (!email || !password) {
            alert('Complete todos los campos');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Verificando...';

        try {
            // Para navegadores Safari/WebKit, agregar timestamp para evitar caché
            const url = 'api.php?action=login&_t=' + Date.now();
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache'
                },
                body: JSON.stringify({ email, password })
            });

            // Verificar si la respuesta es JSON válido
            const text = await response.text();
            let result;
            
            try {
                result = JSON.parse(text);
            } catch (jsonError) {
                console.error('Respuesta no JSON:', text);
                throw new Error('Error en la respuesta del servidor');
            }
            
            console.log('Respuesta completa:', result);
            
            if (!result.success) {
                alert(result.message || 'Credenciales incorrectas');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Entrar';
                return;
            }

            if (!result.user || !result.user.role) {
                alert('Error: datos de usuario incompletos');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Entrar';
                return;
            }

            const role = result.user.role.trim().toLowerCase();
            const userId = result.user.id;
            
            // LIMPIAR COMPLETAMENTE antes de guardar nuevos datos
            localStorage.clear();
            
            // Guardar datos de sesión FRESCOS
            localStorage.setItem('userRole', role);
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userId', userId);
            localStorage.setItem('lastLoginTime', Date.now().toString());
            localStorage.setItem('browser', browser);
            
            // Guardar email para futuro autocompletado (opcional)
            localStorage.setItem('savedEmail', email);
            
            console.log('Datos guardados en localStorage:');
            console.log('- Role:', localStorage.getItem('userRole'));
            console.log('- Email:', localStorage.getItem('userEmail'));
            console.log('- Browser:', localStorage.getItem('browser'));
            
            // Redirigir inmediatamente según rol
            if (role === 'admin') {
                window.location.replace('a_index.html');
            } else {
                window.location.replace('index.html');
            }

        } catch (err) {
            console.error('Error en login:', err);
            alert('Error de conexión: ' + err.message);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Entrar';
        }
    });
});
</script>
</body>
</html>