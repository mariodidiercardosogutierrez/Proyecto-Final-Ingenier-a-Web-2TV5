<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Cat√°logo - SoundSpace Admin</title>
    <link rel="stylesheet" href="style2.css">
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <h2 class="sidebar-title">SoundSpace Admin</h2>
        <nav class="menu">
            <a href="a_index.html">üìä Dashboard</a>
            <a href="a_usuarios.html">üë§ Usuarios</a>
            <a href="a_catalogo.html" class="active">üéµ Cat√°logo</a>
            <a href="a_compras.html">üí∞ Compras</a>
            <a href="#" id="logoutBtn">üö™ Cerrar Sesi√≥n</a>
        </nav>
    </aside>

    <!-- Contenido principal -->
    <main class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>üéµ Gesti√≥n de Cat√°logo</h1>
            <div class="view-switch">
                <button class="view-option active" onclick="switchView('cards')" title="Vista de tarjetas">
                    üóÇÔ∏è
                </button>
                <button class="view-option" onclick="switchView('table')" title="Vista de tabla">
                    üìã
                </button>
            </div>
        </div>
        
        <!-- Pesta√±as -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('albums')">
                üíø √Ålbumes
            </button>
        
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid" id="catalogStats">
            <div class="stat-card">
                <div class="stat-icon">üíø</div>
                <div class="stat-info">
                    <h3>√Ålbumes</h3>
                    <div class="number" id="albumsCount">0</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üéµ</div>
                <div class="stat-info">
                    <h3>Canciones</h3>
                    <div class="number" id="songsCount">0</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üé§</div>
                <div class="stat-info">
                    <h3>Artistas</h3>
                    <div class="number" id="artistsCount">0</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <h3>Valor Cat√°logo</h3>
                    <div class="number" id="catalogValue">$0</div>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar √°lbumes, canciones o artistas...">
                <button onclick="searchCatalog()">
                    üîç Buscar
                </button>
            </div>
            
            <button class="btn" onclick="openAddAlbumModal()">
                üíø Agregar √Ålbum
            </button>
            <button class="btn btn-secondary" onclick="openAddArtistModal()">
                üé§ Agregar Artista
            </button>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <div class="filter-group">
                <label for="genreFilter">G√©nero:</label>
                <select id="genreFilter" onchange="filterCatalog()">
                    <option value="">Todos los g√©neros</option>
                    <!-- G√©neros se cargan din√°micamente -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="artistFilter">Artista:</label>
                <select id="artistFilter" onchange="filterCatalog()">
                    <option value="">Todos los artistas</option>
                    <!-- Artistas se cargan din√°micamente -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="yearFilter">A√±o:</label>
                <select id="yearFilter" onchange="filterCatalog()">
                    <option value="">Todos los a√±os</option>
                    <!-- A√±os se cargan din√°micamente -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="sortBy">Ordenar por:</label>
                <select id="sortBy" onchange="filterCatalog()">
                    <option value="newest">M√°s reciente</option>
                    <option value="oldest">M√°s antiguo</option>
                    <option value="name_asc">Nombre (A-Z)</option>
                    <option value="name_desc">Nombre (Z-A)</option>
                    <option value="price_asc">Precio (bajo a alto)</option>
                    <option value="price_desc">Precio (alto a bajo)</option>
                </select>
            </div>
        </div>

        <!-- Contenido: Vista de tarjetas -->
        <div id="cardsView" class="cards-container">
            <!-- Las tarjetas se cargan din√°micamente -->
            <div class="loading" style="grid-column: 1 / -1;">
                <div class="spinner"></div>
                <p>Cargando cat√°logo...</p>
            </div>
        </div>

        <!-- Contenido: Vista de tabla -->
        <div id="tableView" class="table-container" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th>T√≠tulo</th>
                        <th>Artista</th>
                        <th>G√©nero</th>
                        <th>A√±o</th>
                        <th>Precio</th>
                        <th>Temas</th>
                        <th>Duraci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="catalogTableBody">
                    <tr>
                        <td colspan="9" class="loading">
                            <div class="spinner"></div>
                            <p>Cargando cat√°logo...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginaci√≥n -->
        <div class="pagination" id="pagination">
            <button onclick="changePage(-1)" disabled>‚óÄ Anterior</button>
            <span class="page-info">P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span></span>
            <button onclick="changePage(1)" disabled>Siguiente ‚ñ∂</button>
        </div>

    </main>

    <!-- Modal para agregar/editar √ÅLBUM -->
<div id="albumModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="albumModalTitle">Nuevo √Ålbum</h2>
      <button class="close-modal" onclick="closeAlbumModal()">√ó</button>
    </div>

    <div class="modal-body">
      <form id="albumForm">
        <input type="hidden" id="albumId">

        <div class="form-grid">
          <div class="form-group">
            <label>T√≠tulo</label>
            <input type="text" id="albumTitle" required>
          </div>

          <div class="form-group">
            <label>Artista</label>
            <select id="albumArtistId" required></select>
          </div>

          <div class="form-group">
            <label>A√±o</label>
            <input type="number" id="albumYear" required>
          </div>

          <div class="form-group">
            <label>G√©nero</label>
            <input type="text" id="albumGenre" required>
          </div>

          <div class="form-group">
            <label>Precio</label>
            <input type="number" id="albumPrice" step="0.01" required>
          </div>
        </div>

        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea id="albumDescription"></textarea>
        </div>

        <hr>

        <h3>üéµ Canciones <span style="font-size: 14px; color: #666;">(M√≠nimo 1 canci√≥n)</span></h3>
<div id="songsContainer"></div>

<div style="display: flex; gap: 10px; margin-top: 15px;">
    <button type="button" onclick="addSongRow()" class="btn-secondary" style="flex: 1;">
        ‚ûï Agregar canci√≥n
    </button>
    <button type="button" onclick="clearAllSongs()" class="btn-secondary" style="background: #ff4444; flex: 1;">
        üóëÔ∏è Limpiar todas
    </button>
</div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeAlbumModal()">Cancelar</button>
          <button type="submit" class="btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>


    
    
    
        <!-- Modal para agregar/editar ARTISTA -->
    <div id="artistModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="artistModalTitle">Nuevo Artista</h2>
                <button class="close-modal" onclick="closeArtistModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="artistForm">
                    <input type="hidden" id="artistId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="artistName" class="required">Nombre del Artista</label>
                            <input type="text" id="artistName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="artistEmail" class="required">Correo</label>
                            <input type="email" id="artistEmail" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="artistPassword" class="required">Contrase√±a</label>
                            <input type="password" id="artistPassword" required>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeArtistModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn">
                            Guardar Artista
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="confirmTitle">Confirmar Acci√≥n</h2>
                <button class="close-modal" onclick="closeConfirmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√°s seguro de que quieres realizar esta acci√≥n?</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button class="btn" id="confirmActionBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de vista r√°pida -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="previewTitle">Vista Previa</h2>
                <button class="close-modal" onclick="closePreviewModal()">√ó</button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Contenido de vista previa -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let catalogData = {
            albums: [],
            songs: [],
            artists: [],
            currentTab: 'albums',
            currentView: 'cards',
            currentPage: 1,
            itemsPerPage: 12,
            filteredData: [],
            currentProductId: null,
            currentProductType: 'album'
        };

        // Verificar autenticaci√≥n de admin
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadCatalog();
            loadArtistsForSelect();
            setupEventListeners();
        });

        function checkAdminAuth() {
    const userRole = localStorage.getItem('userRole');
    if (userRole !== 'admin') {
        window.location.replace('login.html');
        return false;
    }
    return true;
}
        function clearAllSongs() {
    const songCount = document.querySelectorAll('.song-row').length;
    if (songCount === 0) return;
    
    if (confirm(`¬øEst√°s seguro de que quieres eliminar todas las ${songCount} canciones?`)) {
        document.getElementById('songsContainer').innerHTML = '';
        if (window.songsToDelete) window.songsToDelete = [];
        // Agregar una fila vac√≠a
        addSongRow();
    }
}

        // Cargar cat√°logo completo
        async function loadCatalog() {
            try {
                showLoading(true);
                
                // Cargar √°lbumes
                const albumsResponse = await fetch('api.php?action=getAlbums');
                const albumsData = await albumsResponse.json();
                
                if (albumsData.success) {
                    catalogData.albums = albumsData.albums;
                }
                
                // Cargar artistas
                const artistsResponse = await fetch('api.php?action=getArtistas');
                const artistsData = await artistsResponse.json();
                
                if (artistsData.success) {
                    catalogData.artists = artistsData.artists;
                }
                
                // Cargar canciones
                const songsResponse = await fetch('api.php?action=getSongsStats');
                const songsData = await songsResponse.json();
                
                if (songsData.success) {
                    catalogData.songs = songsData.songs || [];
                }
                
                updateCatalogStats();
                loadFilters();
                filterCatalog();
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al cargar cat√°logo: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Cargar artistas en select
        async function loadArtistsForSelect() {
            try {
                const response = await fetch('api.php?action=getArtistas');
                const data = await response.json();
                
                const select = document.getElementById('albumArtistId');
                if (select && data.success) {
                    select.innerHTML = '<option value="">Seleccionar artista...</option>';
                    data.artists.forEach(artist => {
                        select.innerHTML += `<option value="${artist.id_artista}">${artist.nombre_artista}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error cargando artistas:', error);
            }
        }

        // Cargar filtros
        function loadFilters() {
            const genreFilter = document.getElementById('genreFilter');
            const artistFilter = document.getElementById('artistFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            // G√©neros √∫nicos
            const genres = [...new Set(catalogData.albums.map(a => a.genero_album))].filter(g => g);
            genreFilter.innerHTML = '<option value="">Todos los g√©neros</option>';
            genres.forEach(genre => {
                genreFilter.innerHTML += `<option value="${genre}">${genre}</option>`;
            });
            
            // Artistas √∫nicos
            artistFilter.innerHTML = '<option value="">Todos los artistas</option>';
            catalogData.artists.forEach(artist => {
                artistFilter.innerHTML += `<option value="${artist.id_artista}">${artist.nombre_artista}</option>`;
            });
            
            // A√±os √∫nicos
            const years = [...new Set(catalogData.albums.map(a => a.anio))].sort((a, b) => b - a);
            yearFilter.innerHTML = '<option value="">Todos los a√±os</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        // Actualizar estad√≠sticas
        function updateCatalogStats() {
            document.getElementById('albumsCount').textContent = catalogData.albums.length;
            document.getElementById('songsCount').textContent = catalogData.songs.length;
            document.getElementById('artistsCount').textContent = catalogData.artists.length;
            
            const totalValue = catalogData.albums.reduce((sum, album) => 
                sum + (parseFloat(album.precio) || 0), 0);
            document.getElementById('catalogValue').textContent = '$' + totalValue.toFixed(2);
        }

        // Filtrar cat√°logo
        function filterCatalog() {
            const genreFilter = document.getElementById('genreFilter').value;
            const artistFilter = document.getElementById('artistFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = catalogData.albums;
            
            // Aplicar filtros
            if (genreFilter) {
                filtered = filtered.filter(album => album.genero_album === genreFilter);
            }
            
            if (artistFilter) {
                filtered = filtered.filter(album => album.id_artista == artistFilter);
            }
            
            if (yearFilter) {
                filtered = filtered.filter(album => album.anio == yearFilter);
            }
            
            // Aplicar b√∫squeda
            if (searchTerm) {
                filtered = filtered.filter(album => 
                    album.titulo.toLowerCase().includes(searchTerm) ||
                    (album.nombre_artista && album.nombre_artista.toLowerCase().includes(searchTerm)) ||
                    (album.genero_album && album.genero_album.toLowerCase().includes(searchTerm))
                );
            }
            
            // Ordenar
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return b.anio - a.anio;
                    case 'oldest':
                        return a.anio - b.anio;
                    case 'name_asc':
                        return a.titulo.localeCompare(b.titulo);
                    case 'name_desc':
                        return b.titulo.localeCompare(a.titulo);
                    case 'price_asc':
                        return (parseFloat(a.precio) || 0) - (parseFloat(b.precio) || 0);
                    case 'price_desc':
                        return (parseFloat(b.precio) || 0) - (parseFloat(a.precio) || 0);
                    default:
                        return b.anio - a.anio;
                }
            });
            
            catalogData.filteredData = filtered;
            catalogData.currentPage = 1;
            renderCatalog();
        }

        // Buscar en cat√°logo
        function searchCatalog() {
            filterCatalog();
        }

        // Renderizar cat√°logo seg√∫n vista
        function renderCatalog() {
            if (catalogData.currentView === 'cards') {
                renderCardsView();
            } else {
                renderTableView();
            }
            updatePagination();
        }

        // Renderizar vista de tarjetas
        function renderCardsView() {
            const container = document.getElementById('cardsView');
            
            if (catalogData.filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div>üéµ</div>
                        <h3>No se encontraron √°lbumes</h3>
                        <p>Prueba con otros filtros o agrega nuevos √°lbumes</p>
                    </div>
                `;
                return;
            }
            
            // Calcular √≠ndices para paginaci√≥n
            const startIndex = (catalogData.currentPage - 1) * catalogData.itemsPerPage;
            const endIndex = startIndex + catalogData.itemsPerPage;
            const pageAlbums = catalogData.filteredData.slice(startIndex, endIndex);
            
            let html = '';
            
            pageAlbums.forEach((album, index) => {
                // Calcular imagen basada en el ID del √°lbum (cada 4 √°lbumes usan las mismas im√°genes)
                let imageNumber = 1;
                if (album.id_album) {
                    imageNumber = ((album.id_album - 1) % 4) + 1; // 1, 2, 3, 4, luego se repite
                }
                const imageUrl = `images/${imageNumber}.png`;
                
                // Determinar si es nuevo o destacado
                const badges = [];
                const currentYear = new Date().getFullYear();
                if (album.anio >= currentYear - 1) badges.push('<span class="badge badge-new">Nuevo</span>');
                if (parseFloat(album.precio) > 500) badges.push('<span class="badge badge-featured">Destacado</span>');
                
             // Dentro de renderCardsView, en la secci√≥n de acciones de la tarjeta:
html += `
    <div class="product-actions">
        <button class="action-btn view-btn" onclick="viewAlbumSongs(${album.id_album})">
            üéµ Ver Canciones
        </button>
        <button class="action-btn view-btn" onclick="viewProduct(${album.id_album})">
            üëÅÔ∏è Ver
        </button>
        <button class="action-btn edit-btn" onclick="editAlbum(${album.id_album})">
            ‚úèÔ∏è Editar
        </button>
        <button class="action-btn delete-btn" onclick="confirmDeleteAlbum(${album.id_album})">
            üóëÔ∏è Eliminar
        </button>
    </div>
`;
            });
            
            container.innerHTML = html;
        }
// Ver canciones del √°lbum
async function viewAlbumSongs(albumId) {
    try {
        const response = await fetch(`api.php?action=getCancionesByAlbum&albumId=${albumId}`);
        const data = await response.json();
        
        if (data.success) {
            const album = data.album;
            let songsHtml = '';
            
            if (data.canciones && data.canciones.length > 0) {
                songsHtml = `
                    <h3 style="color: #8b0000; margin-bottom: 15px;">${album.titulo} - Canciones</h3>
                    <p><strong>Artista:</strong> ${album.nombre_artista}</p>
                    <p><strong>Cantidad de temas:</strong> ${album.cantidadtemas}</p>
                    <div style="margin-top: 20px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f2f2f2;">
                                    <th style="padding: 10px; text-align: left;">#</th>
                                    <th style="padding: 10px; text-align: left;">T√≠tulo</th>
                                    <th style="padding: 10px; text-align: left;">Duraci√≥n</th>
                                    <th style="padding: 10px; text-align: left;">Precio</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.canciones.forEach((song, index) => {
                    songsHtml += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">${index + 1}</td>
                            <td style="padding: 10px;">${song.titulo}</td>
                            <td style="padding: 10px;">${song.duracion}</td>
                            <td style="padding: 10px;">$${parseFloat(song.precio || 0).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                songsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                songsHtml = `
                    <h3 style="color: #8b0000; margin-bottom: 15px;">${album.titulo}</h3>
                    <p><strong>Artista:</strong> ${album.nombre_artista}</p>
                    <p style="color: #666; margin-top: 20px;">Este √°lbum no tiene canciones registradas.</p>
                `;
            }
            
            document.getElementById('previewTitle').textContent = `Canciones: ${album.titulo}`;
            document.getElementById('previewContent').innerHTML = songsHtml;
            document.getElementById('previewModal').style.display = 'flex';
        }
    } catch (error) {
        console.error('Error cargando canciones:', error);
        showNotification('Error al cargar canciones', 'error');
    }
}

        // Renderizar vista de tabla
        function renderTableView() {
            const tbody = document.getElementById('catalogTableBody');
            
            if (catalogData.filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state" style="text-align: center; padding: 40px;">
                            <div>üéµ</div>
                            <h3>No se encontraron √°lbumes</h3>
                            <p>Prueba con otros filtros o agrega nuevos √°lbumes</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calcular √≠ndices para paginaci√≥n
            const startIndex = (catalogData.currentPage - 1) * catalogData.itemsPerPage;
            const endIndex = startIndex + catalogData.itemsPerPage;
            const pageAlbums = catalogData.filteredData.slice(startIndex, endIndex);
            
            let html = '';
            
            pageAlbums.forEach((album, index) => {
                // Calcular imagen para la vista de tabla
                let imageNumber = 1;
                if (album.id_album) {
                    imageNumber = ((album.id_album - 1) % 4) + 1;
                }
                
                html += `
                    <tr>
                        <td>${album.id_album}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="images/${imageNumber}.png" alt="${album.titulo}" 
                                     style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/40x40?text=Album'">
                                <div>
                                    <strong>${album.titulo}</strong><br>
                                    <small style="color: #666;">${album.descripcion_album?.substring(0, 50) || 'Sin descripci√≥n'}...</small>
                                </div>
                            </div>
                        </td>
                        <td>${album.nombre_artista}</td>
                        <td>${album.genero_album}</td>
                        <td>${album.anio}</td>
                        <td><strong>$${parseFloat(album.precio).toFixed(2)}</strong></td>
                        <td>${album.cantidadtemas}</td>
                        <td>${album.duracion_total || 0} min</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button class="view-btn" onclick="viewProduct(${album.id_album})" 
                                        style="padding: 6px 12px; font-size: 12px;">
                                    üëÅÔ∏è
                                </button>
                                <button class="edit-btn" onclick="editAlbum(${album.id_album})"
                                        style="padding: 6px 12px; font-size: 12px;">
                                    ‚úèÔ∏è
                                </button>
                                <button class="delete-btn" onclick="confirmDeleteAlbum(${album.id_album})"
                                        style="padding: 6px 12px; font-size: 12px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Actualizar paginaci√≥n
        function updatePagination() {
            const totalPages = Math.ceil(catalogData.filteredData.length / catalogData.itemsPerPage);
            const pagination = document.getElementById('pagination');
            const prevBtn = pagination.querySelector('button:first-child');
            const nextBtn = pagination.querySelector('button:last-child');
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            
            currentPageSpan.textContent = catalogData.currentPage;
            totalPagesSpan.textContent = totalPages;
            
            prevBtn.disabled = catalogData.currentPage <= 1;
            nextBtn.disabled = catalogData.currentPage >= totalPages;
        }

        // Cambiar p√°gina
        function changePage(direction) {
            const totalPages = Math.ceil(catalogData.filteredData.length / catalogData.itemsPerPage);
            const newPage = catalogData.currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                catalogData.currentPage = newPage;
                renderCatalog();
            }
        }

        // Cambiar pesta√±a
        function switchTab(tabName) {
            catalogData.currentTab = tabName;
            
            // Actualizar botones de pesta√±as
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Aqu√≠ puedes cargar datos espec√≠ficos de cada pesta√±a
            // Por ahora solo manejamos √°lbumes
            if (tabName === 'albums') {
                filterCatalog();
            } else if (tabName === 'artists') {
                // Implementar vista de artistas
                showNotification('Vista de artistas en desarrollo', 'info');
            }
        }

        // Cambiar vista
        function switchView(viewType) {
            catalogData.currentView = viewType;
            
            // Actualizar botones de vista
            document.querySelectorAll('.view-option').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostrar/ocultar vistas
            document.getElementById('cardsView').style.display = viewType === 'cards' ? 'grid' : 'none';
            document.getElementById('tableView').style.display = viewType === 'table' ? 'block' : 'none';
            
            renderCatalog();
        }

        // Ver producto
        function viewProduct(albumId) {
            const album = catalogData.albums.find(a => a.id_album == albumId);
            if (!album) return;
            
            // Calcular imagen basada en el ID del √°lbum
            let imageNumber = 1;
            if (album.id_album) {
                imageNumber = ((album.id_album - 1) % 4) + 1;
            }
            const imageUrl = `images/${imageNumber}.png`;
            
            document.getElementById('previewTitle').textContent = album.titulo;
            document.getElementById('previewContent').innerHTML = `
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 30px;">
                    <div>
                        <img src="${imageUrl}" alt="${album.titulo}" 
                             style="width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/300x300?text=Album+${imageNumber}'">
                    </div>
                    <div>
                        <h3 style="color: #8b0000; margin-bottom: 15px;">${album.titulo}</h3>
                        <p style="margin-bottom: 10px; color: #666;">üé§ <strong>Artista:</strong> ${album.nombre_artista}</p>
                        <p style="margin-bottom: 10px; color: #666;">üìÖ <strong>A√±o:</strong> ${album.anio}</p>
                        <p style="margin-bottom: 10px; color: #666;">üéº <strong>G√©nero:</strong> ${album.genero_album}</p>
                        <p style="margin-bottom: 10px; color: #666;">üéµ <strong>Temas:</strong> ${album.cantidadtemas}</p>
                        <p style="margin-bottom: 10px; color: #666;">‚è±Ô∏è <strong>Duraci√≥n:</strong> ${album.duracion_total || '--'} minutos</p>
                        <p style="margin-bottom: 10px; color: #666;">üí∞ <strong>Precio:</strong> $${parseFloat(album.precio).toFixed(2)}</p>
                        <div style="margin-top: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">Descripci√≥n:</h4>
                            <p style="color: #666; line-height: 1.6;">${album.descripcion_album || 'Sin descripci√≥n disponible.'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('previewModal').style.display = 'flex';
        }

        // Abrir modal para agregar √°lbum
        // Abrir modal para agregar √°lbum
// Abrir modal para agregar √°lbum
function openAddAlbumModal() {
    document.getElementById('albumModalTitle').textContent = 'Nuevo √Ålbum';
    document.getElementById('albumForm').reset();
    document.getElementById('albumId').value = '';
    
    // Establecer valores por defecto
    const currentYear = new Date().getFullYear();
    document.getElementById('albumYear').value = currentYear;
    document.getElementById('albumPrice').value = '99.99';
    document.getElementById('albumGenre').value = 'Pop';
    
    // üî• LIMPIAR LAS CANCIONES PREVIAS
    document.getElementById('songsContainer').innerHTML = '';
    
    // Limpiar lista de canciones a eliminar
    if (window.songsToDelete) window.songsToDelete = [];
    
    // Agregar dos filas vac√≠as por defecto
    addSongRow();
    addSongRow();
    
    openAlbumModal();
}        // Abrir modal para agregar artista
        function openAddArtistModal() {
            document.getElementById('artistModalTitle').textContent = 'Nuevo Artista';
            document.getElementById('artistForm').reset();
            document.getElementById('artistId').value = '';
            openArtistModal();
        }

        // Editar √°lbum
        // Editar √°lbum
// Editar √°lbum
async function editAlbum(albumId) {
    try {
        // Cargar informaci√≥n del √°lbum
        const albumResponse = await fetch('api.php?action=getAlbums');
        const albumData = await albumResponse.json();
        
        if (albumData.success) {
            const album = albumData.albums.find(a => a.id_album == albumId);
            if (album) {
                // üî• LIMPIAR CONTENEDOR ANTES DE AGREGAR NUEVAS CANCIONES
                document.getElementById('songsContainer').innerHTML = '';
                
                // Limpiar lista de canciones a eliminar
                if (window.songsToDelete) window.songsToDelete = [];
                
                // Cargar canciones del √°lbum
                const songsResponse = await fetch(`api.php?action=getCancionesByAlbum&albumId=${albumId}`);
                const songsData = await songsResponse.json();
                
                if (songsData.success && songsData.canciones && songsData.canciones.length > 0) {
                    // Agregar cada canci√≥n existente
                    songsData.canciones.forEach(song => {
                        addSongRow({
                            id_cancion: song.id_cancion,
                            titulo: song.titulo,
                            duracion: song.duracion,
                            precio: song.precio || 0
                        });
                    });
                } else {
                    // Si no hay canciones, agregar una fila vac√≠a
                    addSongRow();
                }
                
                // Rellenar datos del √°lbum
                document.getElementById('albumModalTitle').textContent = 'Editar √Ålbum';
                document.getElementById('albumId').value = album.id_album;
                document.getElementById('albumTitle').value = album.titulo;
                document.getElementById('albumArtistId').value = album.id_artista;
                document.getElementById('albumYear').value = album.anio;
                document.getElementById('albumGenre').value = album.genero_album;
                document.getElementById('albumPrice').value = album.precio;
                document.getElementById('albumDescription').value = album.descripcion_album || '';
                
                openAlbumModal();
            } else {
                showNotification('√Ålbum no encontrado', 'error');
            }
        }
    } catch (error) {
        console.error('Error cargando √°lbum:', error);
        showNotification('Error al cargar datos del √°lbum', 'error');
    }
}

        // Guardar √°lbum
       // Guardar √°lbum
// Guardar √°lbum (versi√≥n final)
// Guardar √°lbum
async function saveAlbum() {
    const form = document.getElementById('albumForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Obtener canciones del formulario
    const songElements = document.querySelectorAll('.song-row');
    const songs = [];
    
    songElements.forEach(row => {
        // Convertir tiempo formato HH:MM a segundos
        const timeInput = row.querySelector('.song-duration').value;
        let durationInSeconds = 0;
        
        if (timeInput) {
            const timeParts = timeInput.split(':');
            if (timeParts.length === 2) {
                const minutes = parseInt(timeParts[0]) || 0;
                const seconds = parseInt(timeParts[1]) || 0;
                durationInSeconds = (minutes * 60) + seconds;
            }
        }
        
        songs.push({
            id_cancion: row.querySelector('.song-id').value || '',
            titulo: row.querySelector('.song-title').value.trim(),
            duracion: durationInSeconds,
            precio: parseFloat(row.querySelector('.song-price').value) || 0
        });
    });
    
    // Validar que al menos haya una canci√≥n
    if (songs.length === 0) {
        showNotification('Debe agregar al menos una canci√≥n', 'error');
        return;
    }
    
    // Validar que todas las canciones tengan t√≠tulo
    const invalidSongs = songs.filter(song => !song.titulo);
    if (invalidSongs.length > 0) {
        showNotification('Todas las canciones deben tener un t√≠tulo', 'error');
        return;
    }
    
    const albumData = {
        titulo: document.getElementById('albumTitle').value.trim(),
        id_artista: parseInt(document.getElementById('albumArtistId').value),
        anio: parseInt(document.getElementById('albumYear').value),
        genero_album: document.getElementById('albumGenre').value.trim(),
        precio: parseFloat(document.getElementById('albumPrice').value),
        descripcion_album: document.getElementById('albumDescription').value.trim(),
        songs: songs
    };
    
    const albumId = document.getElementById('albumId').value;
    
    // Validaciones adicionales
    if (!albumData.titulo || albumData.titulo.length < 2) {
        showNotification('El t√≠tulo del √°lbum debe tener al menos 2 caracteres', 'error');
        return;
    }
    
    if (!albumData.id_artista || albumData.id_artista <= 0) {
        showNotification('Debe seleccionar un artista', 'error');
        return;
    }
    
    if (albumData.anio < 1900 || albumData.anio > new Date().getFullYear()) {
        showNotification('El a√±o debe estar entre 1900 y ' + new Date().getFullYear(), 'error');
        return;
    }
    
    if (albumData.precio <= 0) {
        showNotification('El precio debe ser mayor a 0', 'error');
        return;
    }
    
    try {
        let url = 'api.php?action=createAlbumWithSongs';
        let method = 'POST';
        
        if (albumId) {
            // Actualizar √°lbum existente
            albumData.id_album = parseInt(albumId);
            
            // Agregar canciones marcadas para eliminar
            if (window.songsToDelete && window.songsToDelete.length > 0) {
                albumData.songsToDelete = window.songsToDelete;
            }
            
            url = 'api.php?action=updateAlbumWithSongs';
        }
        
        console.log('Enviando datos:', albumData); // Para debugging
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(albumData)
        });
        
        const result = await response.json();
        
        console.log('Respuesta del servidor:', result); // Para debugging
        
        if (result.success) {
            showNotification(
                albumId ? '√Ålbum actualizado exitosamente' : '√Ålbum creado exitosamente',
                'success'
            );
            
            // Limpiar lista de canciones a eliminar
            if (window.songsToDelete) window.songsToDelete = [];
            
            closeAlbumModal();
            loadCatalog(); // Recargar cat√°logo
        } else {
            throw new Error(result.message || 'Error desconocido del servidor');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al guardar √°lbum: ' + error.message, 'error');
    }
}

// Funci√≥n auxiliar para obtener datos de canciones
function getSongsData() {
    return [...document.querySelectorAll('.song-row')].map(row => {
        const timeInput = row.querySelector('.song-duration').value;
        const [minutes, seconds] = timeInput.split(':').map(Number);
        const durationInSeconds = (minutes * 60) + seconds;
        
        return {
            id_cancion: row.querySelector('.song-id').value || '',
            titulo: row.querySelector('.song-title').value.trim(),
            duracion: durationInSeconds,
            precio: parseFloat(row.querySelector('.song-price').value) || 0
        };
    });
}
        // Guardar artista
        async function saveArtist() {
            const form = document.getElementById('artistForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const artistData = {
                nombre_artista: document.getElementById('artistName').value,
                correo: document.getElementById('artistEmail').value,
                contrasenia: document.getElementById('artistPassword').value
            };
            
            const artistId = document.getElementById('artistId').value;
            
            try {
                let url = 'api.php?action=createArtist';
                let method = 'POST';
                
                if (artistId) {
                    artistData.id_artista = artistId;
                    url = 'api.php?action=updateArtist';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(artistData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(
                        artistId ? 'Artista actualizado exitosamente' : 'Artista creado exitosamente',
                        'success'
                    );
                    closeArtistModal();
                    loadCatalog(); // Recargar cat√°logo
                    loadArtistsForSelect(); // Actualizar select
                } else {
                    throw new Error(result.message || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al guardar artista: ' + error.message, 'error');
            }
        }

        // Confirmar eliminaci√≥n de √°lbum
        function confirmDeleteAlbum(albumId) {
            catalogData.currentProductId = albumId;
            
            const album = catalogData.albums.find(a => a.id_album == albumId);
            const message = album 
                ? `¬øEst√°s seguro de que quieres eliminar el √°lbum "${album.titulo}"?<br><br>
                   <small style="color: #d32f2f;">Esta acci√≥n no se puede deshacer.</small>`
                : '¬øEst√°s seguro de que quieres eliminar este √°lbum?';
            
            document.getElementById('confirmTitle').textContent = 'Confirmar Eliminaci√≥n';
            document.getElementById('confirmMessage').innerHTML = message;
            document.getElementById('confirmActionBtn').onclick = deleteAlbum;
            document.getElementById('confirmActionBtn').textContent = 'Eliminar';
            
            openConfirmModal();
        }

        // Eliminar √°lbum
        async function deleteAlbum() {
            try {
                const response = await fetch('api.php?action=deleteAlbum', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ albumId: catalogData.currentProductId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('√Ålbum eliminado correctamente', 'success');
                    closeConfirmModal();
                    loadCatalog(); // Recargar cat√°logo
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification('Error al eliminar: ' + error.message, 'error');
            }
        }

        // Funciones de modal
        function openAlbumModal() {
            document.getElementById('albumModal').style.display = 'flex';
        }

        function closeAlbumModal() {
    document.getElementById('albumModal').style.display = 'none';
    
    // üî• LIMPIAR TODO AL CERRAR
    document.getElementById('songsContainer').innerHTML = '';
    if (window.songsToDelete) window.songsToDelete = [];
    
    // Tambi√©n puedes resetear el formulario completamente
    document.getElementById('albumForm').reset();
}

        function openArtistModal() {
            document.getElementById('artistModal').style.display = 'flex';
        }

        function closeArtistModal() {
            document.getElementById('artistModal').style.display = 'none';
        }

        function openConfirmModal() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            catalogData.currentProductId = null;
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Funciones de utilidad
        function showLoading(show) {
            const container = document.getElementById('cardsView');
            if (show) {
                container.innerHTML = `
                    <div class="loading" style="grid-column: 1 / -1;">
                        <div class="spinner"></div>
                        <p>Cargando cat√°logo...</p>
                    </div>
                `;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Buscar con Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchCatalog();
            });
            
            // Bot√≥n de logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    localStorage.clear();
                    window.location.href = 'login.html';
                }
            });
            
            // Formulario de √°lbum
            document.getElementById('albumForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAlbum();
            });
            
            // Formulario de artista
            document.getElementById('artistForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveArtist();
            });
            
            // Cerrar modales haciendo clic fuera
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }
        function addSongRow(song = {}) {
    const container = document.getElementById('songsContainer');
    
    const row = document.createElement('div');
    row.className = 'song-row';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '2fr 1fr 1fr auto';
    row.style.gap = '10px';
    row.style.marginBottom = '10px';
    row.style.alignItems = 'center';
    row.style.padding = '10px';
    row.style.border = '1px solid #ddd';
    row.style.borderRadius = '5px';
    row.style.backgroundColor = '#f9f9f9';
    
    // Formatear duraci√≥n para input time (formato: HH:MM)
    let durationValue = '00:00';
    if (song.duracion) {
        if (typeof song.duracion === 'number') {
            // Si es n√∫mero (segundos), convertir a MM:SS
            const minutes = Math.floor(song.duracion / 60);
            const seconds = song.duracion % 60;
            durationValue = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else if (typeof song.duracion === 'string') {
            // Si es string, verificar formato
            if (song.duracion.includes(':')) {
                durationValue = song.duracion;
            }
        }
    }
    
    row.innerHTML = `
        <input type="hidden" class="song-id" value="${song.id_cancion || ''}">
        <input type="text" class="song-title" placeholder="T√≠tulo de la canci√≥n" 
               value="${song.titulo || ''}" required style="padding: 8px;">
        <input type="time" class="song-duration" step="1" 
               value="${durationValue}" required style="padding: 8px;">
        <input type="number" class="song-price" placeholder="Precio" step="0.01" 
               min="0" value="${song.precio || 0}" style="padding: 8px;">
        <button type="button" class="delete-song-btn" onclick="removeSongRow(this)" 
                title="Eliminar canci√≥n" style="padding: 8px 12px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üóëÔ∏è
        </button>
    `;
    
    container.appendChild(row);
}

// Funci√≥n auxiliar para formatear tiempo
function formatTimeForInput(timeStr) {
    if (!timeStr) return '00:00';
    
    // Si ya est√° en formato HH:MM:SS o MM:SS
    if (timeStr.includes(':')) {
        const parts = timeStr.split(':');
        if (parts.length === 3) {
            // Formato HH:MM:SS -> convertir a MM:SS
            const minutes = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            return `${minutes.toString().padStart(2, '0')}:${parts[2].padStart(2, '0')}`;
        }
        return timeStr.length === 5 ? timeStr : '00:00';
    }
    
    // Si es un n√∫mero (segundos)
    const totalSeconds = parseInt(timeStr);
    if (!isNaN(totalSeconds)) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    return '00:00';
}

// Funci√≥n para eliminar fila de canci√≥n
function removeSongRow(button) {
    const row = button.closest('.song-row');
    if (row) {
        // Si tiene un ID de canci√≥n, marcarla para eliminaci√≥n
        const songId = row.querySelector('.song-id').value;
        if (songId) {
            if (!window.songsToDelete) window.songsToDelete = [];
            window.songsToDelete.push(songId);
        }
        row.remove();
    }
}
    </script>
</body>
</html>