<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundSpace - Mis Tarjetas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- BOT√ìN QUE MUESTRA LA SIDEBAR -->
    <button id="showSidebarBtn" class="show-sidebar-btn">‚ûï</button>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-hide-btn">üóï</button>
        </div>

        <nav class="menu">
            <p class="section-title">Navegaci√≥n</p>
            <a href="index.html">Inicio</a>
            <a href="albumes.html">G√©neros</a>
            <a href="artistas.html">Artistas</a>
            <a href="compras.html">Mis Compras</a>
            <a href="tarjetas.html" class="active">Tarjetas</a>

            <p class="section-title">Del usuario</p>
            <a href="biblioteca.html">Biblioteca</a>
            <a href="favoritos.html">Favoritos</a>
        </nav>
    </aside>

    <!-- CONTENIDO -->
    <div class="content">
        <!-- HEADER -->
        <header class="header">
            <div class="header-logo">
                <img src="images/logo.png" alt="SoundSpace">
            </div>

            <div class="icons">
                <a href="carrito.html" class="icon-btn">üõí</a>

                <div class="user-dropdown">
                    <button class="user-btn icon-btn">üë§</button>

                    <div class="dropdown-menu">
                        <div class="user-info">
                            <strong id="userNameDisplay"></strong><br>
                            <small id="userEmailDisplay"></small>
                        </div>

                        <div class="dropdown-divider"></div>
                        <button id="logoutBtnDropdown" class="dropdown-item logout-btn">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- SECCI√ìN PRINCIPAL -->
        <main>
            <section class="catalog-section">
                <div class="catalog-container">
                    <div class="catalog-header">
                        <h2>Mis Tarjetas de Cr√©dito/D√©bito</h2>
                        <p>Gestiona tus tarjetas guardadas para compras r√°pidas.</p>
                        
                        <div style="margin-top: 20px;">
                            <button id="addCardBtn" class="add-card-btn" style="
                                background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 16px;
                                transition: transform 0.2s;
                            ">
                                Ôºã Agregar Nueva Tarjeta
                            </button>
                        </div>
                    </div>

                    <!-- CONTENEDOR DIN√ÅMICO DE TARJETAS -->
                    <div id="cardsContainer" style="margin-top: 30px;">
                        <div class="cards-loading">
                            Cargando tus tarjetas...
                        </div>
                    </div>

                    <!-- FORMULARIO PARA AGREGAR NUEVA TARJETA (OCULTO INICIALMENTE) -->
                    <div id="addCardForm" style="display: none; margin-top: 40px; padding: 30px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin-bottom: 25px; color: #333;">Agregar Nueva Tarjeta</h3>
                        
                        <form id="newCardForm" style="max-width: 600px; margin: 0 auto;">
                            <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                                        Nombre del Titular
                                    </label>
                                    <input type="text" id="cardName" name="cardName" required
                                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"
                                           placeholder="Ej: JUAN PEREZ">
                                </div>
                            </div>
                            
                            <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                                        N√∫mero de Tarjeta
                                    </label>
                                    <input type="text" id="cardNumber" name="cardNumber" required
                                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"
                                           placeholder="1234 5678 9012 3456"
                                           maxlength="19"
                                           oninput="formatCardNumber(this)">
                                </div>
                            </div>
                            
                            <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                                        Mes de Expiraci√≥n
                                    </label>
                                    <select id="cardMonth" name="cardMonth" required
                                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                        <option value="">MM</option>
                                        <option value="01">01 - Enero</option>
                                        <option value="02">02 - Febrero</option>
                                        <option value="03">03 - Marzo</option>
                                        <option value="04">04 - Abril</option>
                                        <option value="05">05 - Mayo</option>
                                        <option value="06">06 - Junio</option>
                                        <option value="07">07 - Julio</option>
                                        <option value="08">08 - Agosto</option>
                                        <option value="09">09 - Septiembre</option>
                                        <option value="10">10 - Octubre</option>
                                        <option value="11">11 - Noviembre</option>
                                        <option value="12">12 - Diciembre</option>
                                    </select>
                                </div>
                                
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                                        A√±o de Expiraci√≥n
                                    </label>
                                    <select id="cardYear" name="cardYear" required
                                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                                        <option value="">AAAA</option>
                                        <!-- Los a√±os se generar√°n din√°micamente -->
                                    </select>
                                </div>
                                
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">
                                        CVV
                                    </label>
                                    <input type="text" id="cardCVV" name="cardCVV" required
                                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"
                                           placeholder="123"
                                           maxlength="4"
                                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                </div>
                            </div>
                            
                            <div class="form-actions" style="display: flex; gap: 15px; margin-top: 30px;">
                                <button type="submit" class="save-card-btn" style="
                                    flex: 1;
                                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                    color: white;
                                    border: none;
                                    padding: 14px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-weight: bold;
                                    font-size: 16px;
                                ">
                                    üí≥ Guardar Tarjeta
                                </button>
                                
                                <button type="button" id="cancelCardBtn" style="
                                    flex: 1;
                                    background: #f44336;
                                    color: white;
                                    border: none;
                                    padding: 14px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-weight: bold;
                                    font-size: 16px;
                                ">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </section>
        </main>

        <footer>
            <p>¬© 2025 Soundspace - Todos los derechos reservados</p>
        </footer>
    </div>

    <!-- SCRIPTS -->
    <script>
        // VERIFICACI√ìN DE LOGIN
        document.addEventListener("DOMContentLoaded", function () {
            const userId = localStorage.getItem('userId');
            const userEmail = localStorage.getItem('userEmail');
            
            console.log('Verificando login en tarjetas...');
            console.log('UserID:', userId);
            
            // Si no hay usuario logueado, redirigir a login
            if (!userId || !userEmail) {
                console.log('No hay usuario logueado, redirigiendo a login...');
                alert('Por favor, inicie sesi√≥n para ver tus tarjetas');
                window.location.href = 'login.html';
            } else {
                console.log('Usuario logueado:', userEmail);
                // Mostrar informaci√≥n del usuario
                document.getElementById('userNameDisplay').textContent = localStorage.getItem('userName') || 'Usuario';
                document.getElementById('userEmailDisplay').textContent = userEmail;
                
                // Inicializar a√±os para tarjetas
                initializeYearOptions();
                
                // Cargar las tarjetas del usuario
                loadUserCards();
                
                // Configurar eventos
                setupEventListeners();
            }
        });

        // ==================== FUNCIONES DE TARJETAS ====================

        // 1) Inicializar opciones de a√±o (desde el a√±o actual hasta +10 a√±os)
        function initializeYearOptions() {
            const yearSelect = document.getElementById('cardYear');
            const currentYear = new Date().getFullYear();
            
            // Limpiar opciones excepto la primera
            while (yearSelect.options.length > 1) {
                yearSelect.remove(1);
            }
            
            // Agregar opciones para los pr√≥ximos 10 a√±os
            for (let i = 0; i <= 10; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // 2) Formatear n√∫mero de tarjeta con espacios cada 4 d√≠gitos
        function formatCardNumber(input) {
            // Solo permitir n√∫meros
            let value = input.value.replace(/\D/g, '');
            
            // Agrupar en bloques de 4
            let formatted = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            input.value = formatted;
        }

        // 3) Cargar tarjetas del usuario
        async function loadUserCards() {
            const userId = localStorage.getItem('userId');
            
            if (!userId) {
                showErrorMessage("No se pudo identificar al usuario.");
                return;
            }
            
            try {
                const response = await fetch(`api.php?action=getUserCards&userId=${userId}`);
                const data = await response.json();
                
                if (!data.success) {
                    showNoCardsMessage("Error al cargar tus tarjetas");
                    return;
                }
                
                if (!data.cards || data.cards.length === 0) {
                    showNoCardsMessage();
                    return;
                }
                
                // Mostrar las tarjetas
                displayUserCards(data.cards);
                
            } catch (error) {
                console.error("Error cargando tarjetas:", error);
                showErrorMessage("Error de conexi√≥n. Intente m√°s tarde.");
            }
        }

        // 4) Mostrar tarjetas del usuario
        function displayUserCards(cards) {
            const container = document.getElementById('cardsContainer');
            
            container.innerHTML = '';
            
            cards.forEach((card, index) => {
                const cardElement = createCardElement(card);
                container.appendChild(cardElement);
            });
        }

        // 5) Crear elemento HTML para una tarjeta
        function createCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'credit-card';
            cardDiv.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 12px;
                padding: 25px;
                margin-bottom: 20px;
                box-shadow: 0 8px 16px rgba(0,0,0,0.1);
                position: relative;
                animation: fadeIn 0.5s ease;
                min-height: 180px;
            `;
            
            // Determinar tipo de tarjeta basado en el primer d√≠gito
            const firstDigit = card.numero_tarjeta.charAt(0);
            let cardType = 'Tarjeta';
            let cardIcon = 'üí≥';
            
            if (firstDigit === '4') {
                cardType = 'Visa';
                cardIcon = 'üí≥';
            } else if (firstDigit === '5') {
                cardType = 'Mastercard';
                cardIcon = 'üí≥';
            }
            
            // Formatear n√∫mero de tarjeta para mostrar solo los √∫ltimos 4 d√≠gitos
            const lastFour = card.numero_tarjeta.substring(card.numero_tarjeta.length - 4);
            const formattedNumber = `**** **** **** ${lastFour}`;
            
            cardDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 20px; font-weight: bold;">${cardIcon} ${cardType}</div>
                    <div style="font-size: 18px; letter-spacing: 2px;">${formattedNumber}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Titular</div>
                    <div style="font-size: 18px; font-weight: 500;">${card.nombre_titular}</div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Expiraci√≥n</div>
                        <div style="font-size: 16px; font-weight: 500;">${card.mes_exp}/${card.anio_exp}</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="use-card-btn" data-id="${card.id_tarjeta}" style="
                            background: rgba(255, 255, 255, 0.2);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.3s;
                        ">
                            Usar para compras
                        </button>
                        
                        <button class="delete-card-btn" data-id="${card.id_tarjeta}" data-number="${formattedNumber}" style="
                            background: rgba(255, 255, 255, 0.1);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.3s;
                        ">
                            Eliminar
                        </button>
                    </div>
                </div>
                
                <div style="position: absolute; top: 15px; right: 15px; font-size: 12px; opacity: 0.8;">
                    ${card.fecha_registro ? 'Agregada: ' + formatDate(card.fecha_registro) : ''}
                </div>
            `;
            
            return cardDiv;
        }

        // 6) Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // 7) Mostrar mensaje cuando no hay tarjetas
        function showNoCardsMessage(message = null) {
            const container = document.getElementById('cardsContainer');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üí≥</div>
                    <h3 style="margin-bottom: 15px;">${message || 'No tienes tarjetas guardadas'}</h3>
                    <p style="margin-bottom: 25px;">Agrega una tarjeta para realizar compras de forma m√°s r√°pida y segura.</p>
                    <p style="font-size: 14px; color: #999;">
                        <em>Tu informaci√≥n de tarjetas se almacena de forma segura y encriptada.</em>
                    </p>
                </div>
            `;
        }

        // 8) Mostrar mensajes de error
        function showErrorMessage(message) {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #8b0000;">
                    <h3>Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // 9) Configurar event listeners
        function setupEventListeners() {
            // Bot√≥n para agregar nueva tarjeta
            const addCardBtn = document.getElementById('addCardBtn');
            const cancelCardBtn = document.getElementById('cancelCardBtn');
            const addCardForm = document.getElementById('addCardForm');
            const newCardForm = document.getElementById('newCardForm');
            
            addCardBtn.addEventListener('click', function() {
                addCardForm.style.display = 'block';
                addCardBtn.style.display = 'none';
                addCardForm.scrollIntoView({ behavior: 'smooth' });
            });
            
            cancelCardBtn.addEventListener('click', function() {
                addCardForm.style.display = 'none';
                addCardBtn.style.display = 'inline-block';
                newCardForm.reset();
            });
            
            // Enviar formulario de nueva tarjeta
           // En la parte del submit del formulario (dentro de setupEventListeners):
newCardForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const userId = localStorage.getItem('userId');
    const cardName = document.getElementById('cardName').value.trim();
    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
    const cardMonth = document.getElementById('cardMonth').value;
    const cardYear = document.getElementById('cardYear').value;
    const cardCVV = document.getElementById('cardCVV').value.trim();
    
    // Validaciones b√°sicas
    if (!cardName || !cardNumber || !cardMonth || !cardYear || !cardCVV) {
        alert('Todos los campos son obligatorios');
        return;
    }
    
    // Validaciones avanzadas
    if (!validateCardData(cardName, cardNumber, cardMonth, cardYear, cardCVV)) {
        return;
    }
    
    // Mostrar mensaje de procesamiento
    const submitBtn = document.querySelector('.save-card-btn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Procesando...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('api.php?action=addUserCard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: parseInt(userId),
                nombre_titular: cardName,
                numero_tarjeta: cardNumber,
                mes_exp: cardMonth,
                anio_exp: cardYear,
                cvv: cardCVV
            })
        });
        
        const result = await response.json();
        
        // Restaurar bot√≥n
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        
        if (result.success) {
            showNotification('‚úÖ Tarjeta agregada correctamente');
            
            // Ocultar formulario y mostrar bot√≥n
            addCardForm.style.display = 'none';
            addCardBtn.style.display = 'inline-block';
            newCardForm.reset();
            
            // Recargar la lista de tarjetas
            setTimeout(() => {
                loadUserCards();
            }, 500);
            
        } else {
            // Mostrar error espec√≠fico
            showNotification('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        // Restaurar bot√≥n
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        
        console.error('Error agregando tarjeta:', error);
        showNotification('‚ùå Error de conexi√≥n. Intenta nuevamente.', 'error');
    }
});
            
            // Delegar eventos para botones din√°micos
            document.addEventListener('click', async function(e) {
                // Bot√≥n eliminar tarjeta
                if (e.target.classList.contains('delete-card-btn')) {
                    const cardId = e.target.getAttribute('data-id');
                    const cardNumber = e.target.getAttribute('data-number');
                    
                    if (confirm(`¬øEst√°s seguro de que quieres eliminar la tarjeta ${cardNumber}?`)) {
                        await deleteCard(cardId);
                    }
                }
                
                // Bot√≥n usar tarjeta para compras
                if (e.target.classList.contains('use-card-btn')) {
                    const cardId = e.target.getAttribute('data-id');
                    localStorage.setItem('selectedCardId', cardId);
                    showNotification('‚úÖ Tarjeta seleccionada para futuras compras');
                }
            });
        }

        // 10) Validar datos de tarjeta
        // 10) Validar datos de tarjeta (VERSI√ìN MEJORADA PERO SIMPLE)
function validateCardData(name, number, month, year, cvv) {
    // Validar nombre
    if (name.length < 3) {
        alert('El nombre del titular debe tener al menos 3 caracteres');
        return false;
    }
    
    // Validar n√∫mero de tarjeta (debe tener entre 13 y 19 d√≠gitos)
    const cleanNumber = number.replace(/\D/g, '');
    if (cleanNumber.length < 13 || cleanNumber.length > 19) {
        alert('El n√∫mero de tarjeta debe tener entre 13 y 19 d√≠gitos');
        return false;
    }
    
    // Validar algoritmo de Luhn (solo si quieres esta validaci√≥n extra)
    if (!validateLuhn(cleanNumber)) {
        alert('El n√∫mero de tarjeta no es v√°lido. Por favor verif√≠calo.');
        return false;
    }
    
    // Validar fecha de expiraci√≥n
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1; // Enero es 0
    
    if (parseInt(year) < currentYear || 
        (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
        alert('La tarjeta est√° expirada');
        return false;
    }
    
    // Validar CVV
    if (!/^\d{3,4}$/.test(cvv)) {
        alert('El CVV debe tener 3 o 4 d√≠gitos num√©ricos');
        return false;
    }
    
    return true;
}

// 10.1) Algoritmo de Luhn para validar tarjetas (OPCIONAL)
function validateLuhn(cardNumber) {
    // Solo validar si el n√∫mero tiene al menos 13 d√≠gitos
    if (cardNumber.length < 13) return true;
    
    let sum = 0;
    let isEven = false;
    
    // Recorrer n√∫meros de derecha a izquierda
    for (let i = cardNumber.length - 1; i >= 0; i--) {
        let digit = parseInt(cardNumber.charAt(i), 10);
        
        if (isEven) {
            digit *= 2;
            if (digit > 9) {
                digit -= 9;
            }
        }
        
        sum += digit;
        isEven = !isEven;
    }
    
    return (sum % 10) === 0;
}

// 11) Mejorar funci√≥n eliminar tarjeta
async function deleteCard(cardId) {
    const userId = localStorage.getItem('userId');
    
    // Verificar si la tarjeta est√° siendo usada en compras
    try {
        const checkResponse = await fetch(`api.php?action=checkCardUsage&userId=${userId}&cardId=${cardId}`);
        const checkResult = await checkResponse.json();
        
        if (checkResult.usedInPurchases) {
            if (!confirm(`Esta tarjeta tiene ${checkResult.purchaseCount} compra(s) asociada(s).\n¬øEst√°s seguro de que quieres eliminarla?\nLas compras existentes mantendr√°n el registro hist√≥rico.`)) {
                return;
            }
        }
        
    } catch (error) {
        // Si no existe la acci√≥n, continuar normalmente
        console.log('Verificaci√≥n de uso no disponible');
    }
    
    if (!confirm(`¬øEst√°s seguro de que quieres eliminar esta tarjeta?\nEsta acci√≥n no se puede deshacer.`)) {
        return;
    }
    
    try {
        const response = await fetch('api.php?action=deleteUserCard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: parseInt(userId),
                cardId: parseInt(cardId)
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('üóëÔ∏è Tarjeta eliminada correctamente');
            
            // Recargar la lista de tarjetas
            setTimeout(() => {
                loadUserCards();
            }, 500);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error eliminando tarjeta:', error);
        alert('Error de conexi√≥n al servidor');
    }
}

// 12) Mostrar notificaciones (VERSI√ìN MEJORADA)
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)' : 
                     type === 'error' ? 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)' :
                     'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)'};
        color: white;
        padding: 15px 20px;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
        word-wrap: break-word;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

        // 11) Eliminar tarjeta
        async function deleteCard(cardId) {
            const userId = localStorage.getItem('userId');
            
            try {
                const response = await fetch('api.php?action=deleteUserCard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        cardId: parseInt(cardId)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('üóëÔ∏è Tarjeta eliminada correctamente');
                    
                    // Recargar la lista de tarjetas
                    setTimeout(() => {
                        loadUserCards();
                    }, 500);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error eliminando tarjeta:', error);
                alert('Error de conexi√≥n al servidor');
            }
        }

        // 12) Mostrar notificaciones
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 13) Configurar logout
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtnDropdown');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem("userEmail");
                    localStorage.removeItem("userName");
                    localStorage.removeItem("userId");
                    localStorage.removeItem("userRole");
                    localStorage.removeItem("selectedCardId");
                    alert("Sesi√≥n cerrada correctamente");
                    window.location.href = "index.html";
                });
            }
        });

    </script>

    <!-- Script principal para la sidebar -->
    <script src="main.js"></script>
    
    <!-- Estilos adicionales -->
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .add-card-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(106, 17, 203, 0.3);
        }
        
        .save-card-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.3);
        }
        
        .use-card-btn:hover {
            background: rgba(255, 255, 255, 0.3) !important;
        }
        
        .delete-card-btn:hover {
            background: rgba(255, 0, 0, 0.2) !important;
        }
        
        .credit-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .credit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        
        .cards-loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
    </style>
</body>
</html>