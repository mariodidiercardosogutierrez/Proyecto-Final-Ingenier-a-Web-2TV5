<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Carrito - SoundSpace</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- BOT√ìN QUE MUESTRA LA SIDEBAR -->
    <button id="showSidebarBtn" class="show-sidebar-btn">‚ûï</button>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-hide-btn">üóï</button>
        </div>

        <nav class="menu">
            <p class="section-title">Navegaci√≥n</p>
            <a href="index.html">Inicio</a>
            <a href="albumes.html">G√©neros</a>
            <a href="artistas.html">Artistas</a>
            <a href="compras.html">Mis Compras</a>
            <a href="tarjetas.html">Tarjetas</a>

            <p class="section-title">Del usuario</p>
            <a href="biblioteca.html">Biblioteca</a>
            <a href="favoritos.html">Favoritos</a>
           
        </nav>
    </aside>

    <!-- CONTENIDO -->
    <div class="content">
        <!-- HEADER -->
        <header class="header">
            <div class="header-logo">
                <img src="images/logo.png" alt="SoundSpace">
            </div>

            <div class="icons">
                <a href="carrito.html" class="icon-btn">üõí</a>

                <div class="user-dropdown">
                    <button class="user-btn icon-btn">üë§</button>

                    <div class="dropdown-menu">
                        <div class="user-info">
                            <strong id="userNameDisplay"></strong><br>
                            <small id="userEmailDisplay"></small>
                        </div>

                        <div class="dropdown-divider"></div>
                        <button id="logoutBtnDropdown" class="dropdown-item logout-btn">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- SECCI√ìN PRINCIPAL -->
        <main>
            <section class="catalog-section">
                <div class="catalog-container">
                    <div class="catalog-header">
                        <h2>üõí Mi Carrito de Compras</h2>
                        <p id="cartSummary">Cargando carrito...</p>
                    </div>
                    
                    <div id="cartContent" style="min-height: 300px;">
                        <p style="text-align: center; padding: 40px; color: #666;">
                            Cargando tu carrito...
                        </p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>¬© 2025 Soundspace - Todos los derechos reservados</p>
        </footer>
    </div>

    <script src="main.js"></script>
    <script>
        // Script simplificado para debugging
        
        async function testAPI() {
            console.log('=== TEST API ===');
            try {
                const response = await fetch('api.php?action=test');
                const data = await response.json();
                console.log('API Test Result:', data);
                return data.success;
            } catch (error) {
                console.error('API Test Error:', error);
                return false;
            }
        }
        
        async function loadCartSimple() {
            const userId = localStorage.getItem('userId');
            const cartContent = document.getElementById('cartContent');
            const cartSummary = document.getElementById('cartSummary');
            
            console.log('User ID:', userId);
            
            // Primero probar la API
            const apiWorks = await testAPI();
            if (!apiWorks) {
                cartContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8b0000;">
                        <h3>‚ö†Ô∏è API NO RESPONDE</h3>
                        <p>No se puede conectar con api.php</p>
                        <p>Abre la consola (F12) para ver los errores.</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #8b0000; color: white; border: none; border-radius: 4px;">Reintentar</button>
                    </div>
                `;
                return;
            }
            
            if (!userId) {
                cartContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #8b0000;">No est√°s logueado</h3>
                        <a href="login.html" style="margin-top: 20px; display: inline-block; padding: 10px 20px; background: #8b0000; color: white; text-decoration: none; border-radius: 4px;">Iniciar Sesi√≥n</a>
                    </div>
                `;
                cartSummary.textContent = 'Usuario no autenticado';
                return;
            }
            
            try {
                console.log('Cargando carrito para usuario:', userId);
                const response = await fetch(`api.php?action=getCartItems&userId=${userId}`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Carrito data:', data);
                
                if (data.success) {
                    if (data.items && data.items.length > 0) {
                        let html = '<div style="background: white; padding: 20px; border-radius: 8px;">';
                        html += `<h3>${data.items.length} producto(s) en el carrito</h3>`;
                        
                        data.items.forEach((item, index) => {
                            html += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                    <strong>${item.nombre || 'Producto ' + (index + 1)}</strong><br>
                                    <small>${item.artista || ''} - $${item.precio_unitario || 0} x ${item.cantidad || 1}</small>
                                    <button onclick="removeItem(${item.id})" style="margin-left: 10px; padding: 5px 10px; background: #8b0000; color: white; border: none; border-radius: 4px; font-size: 12px;">Eliminar</button>
                                </div>
                            `;
                        });
                        
                        html += `<div style="margin-top: 20px; font-weight: bold; text-align: right;">
                                    Total: $${data.total || 0} MXN
                                 </div>`;
                        html += `<div style="margin-top: 20px;">
                                    <button onclick="clearCartSimple()" style="margin-right: 10px; padding: 10px 20px; background: #ccc; color: #333; border: none; border-radius: 4px;">Vaciar Carrito</button>
                                    <button onclick="checkoutSimple()" style="padding: 10px 20px; background: #8b0000; color: white; border: none; border-radius: 4px;">Proceder al Pago</button>
                                 </div>`;
                        html += '</div>';
                        
                        cartContent.innerHTML = html;
                        cartSummary.textContent = `${data.items.length} producto(s) - $${data.total || 0} MXN`;
                    } else {
                        cartContent.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <h3 style="color: #666;">Tu carrito est√° vac√≠o</h3>
                                <a href="index.html" style="margin-top: 20px; display: inline-block; padding: 10px 20px; background: #8b0000; color: white; text-decoration: none; border-radius: 4px;">Ver Cat√°logo</a>
                            </div>
                        `;
                        cartSummary.textContent = 'Carrito vac√≠o';
                    }
                } else {
                    cartContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #8b0000;">
                            <h3>Error en la API</h3>
                            <p>${data.message || 'Error desconocido'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                cartContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8b0000;">
                        <h3>Error de conexi√≥n</h3>
                        <p>${error.message}</p>
                        <button onclick="loadCartSimple()" style="margin-top: 20px; padding: 10px 20px; background: #8b0000; color: white; border: none; border-radius: 4px;">Reintentar</button>
                    </div>
                `;
            }
        }
        
        async function removeItem(itemId) {
            if (!confirm('¬øEliminar este producto?')) return;
            
            try {
                const response = await fetch('api.php?action=removeFromCart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId: itemId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Producto eliminado');
                    loadCartSimple();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }
        
        async function clearCartSimple() {
            if (!confirm('¬øVaciar todo el carrito?')) return;
            
            const userId = localStorage.getItem('userId');
            if (!userId) return;
            
            try {
                const cartResponse = await fetch(`api.php?action=getCartItems&userId=${userId}`);
                const cartData = await cartResponse.json();
                
                if (cartData.success && cartData.cartId) {
                    const response = await fetch('api.php?action=clearCart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cartId: cartData.cartId })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Carrito vaciado');
                        loadCartSimple();
                    } else {
                        alert('Error: ' + result.message);
                    }
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }
        
        async function checkoutSimple() {
    const userId = localStorage.getItem('userId');
    if (!userId) {
        alert('Por favor, inicia sesi√≥n para proceder con el pago');
        window.location.href = 'login.html';
        return;
    }
    
    try {
        // 1. Obtener las tarjetas del usuario
        const cardsResponse = await fetch(`api.php?action=getUserCards&userId=${userId}`);
        const cardsData = await cardsResponse.json();
        
        if (!cardsData.success || !cardsData.cards || cardsData.cards.length === 0) {
            // Si no tiene tarjetas, preguntar si quiere agregar una
            const addCard = confirm('No tienes tarjetas registradas. ¬øTe gustar√≠a agregar una ahora?');
            if (addCard) {
                window.location.href = 'tarjetas.html';
            } else {
                alert('Necesitas una tarjeta registrada para realizar la compra');
            }
            return;
        }
        
        // 2. Mostrar modal para seleccionar tarjeta
        showCardSelectionModal(cardsData.cards);
        
    } catch (error) {
        console.error('Error cargando tarjetas:', error);
        alert('Error al cargar las tarjetas. Intenta nuevamente.');
    }
}

// Funci√≥n para mostrar modal de selecci√≥n de tarjeta
function showCardSelectionModal(cards) {
    // Crear modal
    const modalHTML = `
        <div id="cardSelectionModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        ">
            <div style="
                background: white;
                padding: 30px;
                border-radius: 8px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            ">
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                ">
                    <h3 style="margin: 0; color: #333;">Seleccionar Tarjeta</h3>
                    <button id="closeModalBtn" style="
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                    ">√ó</button>
                </div>
                
                <p style="color: #666; margin-bottom: 25px;">
                    Selecciona una tarjeta registrada o agrega una nueva
                </p>
                
                <div id="cardsList" style="margin-bottom: 25px; max-height: 300px; overflow-y: auto;">
                    ${cards.map((card, index) => `
                        <div class="card-option" data-id="${card.id_tarjeta}" style="
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            padding: 15px;
                            margin-bottom: 10px;
                            cursor: pointer;
                            transition: border-color 0.3s, background 0.3s;
                        " onclick="selectCard(${card.id_tarjeta})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${card.nombre_titular}</strong>
                                    <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                        **** **** **** ${card.numero_tarjeta.slice(-4)}
                                    </div>
                                    <div style="color: #888; font-size: 12px; margin-top: 5px;">
                                        Expira: ${card.mes_exp}/${card.anio_exp}
                                    </div>
                                </div>
                                <div class="card-check" id="check-${card.id_tarjeta}" style="
                                    display: none;
                                    color: #8b0000;
                                    font-size: 20px;
                                ">‚úì</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <button id="useSelectedCardBtn" style="
                        flex: 2;
                        background: #8b0000;
                        color: white;
                        border: none;
                        padding: 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                        display: none;
                    ">
                        Usar Tarjeta Seleccionada
                    </button>
                    
                    <button id="addNewCardBtn" style="
                        flex: 1;
                        background: #f0f0f0;
                        color: #333;
                        border: 1px solid #ddd;
                        padding: 12px;
                        border-radius: 4px;
                        cursor: pointer;
                    ">
                        Ôºã Agregar Nueva
                    </button>
                </div>
                
                <div style="text-align: center; color: #888; font-size: 12px;">
                    <em>Tu informaci√≥n de tarjeta est√° almacenada de forma segura</em>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Configurar eventos
    setupModalEvents();
}

// Configurar eventos del modal
function setupModalEvents() {
    const modal = document.getElementById('cardSelectionModal');
    const closeBtn = document.getElementById('closeModalBtn');
    const useCardBtn = document.getElementById('useSelectedCardBtn');
    const addNewCardBtn = document.getElementById('addNewCardBtn');
    
    // Cerrar modal
    closeBtn.onclick = function() {
        modal.remove();
    };
    
    // Cerrar al hacer clic fuera
    modal.onclick = function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    };
    
    // Bot√≥n "Usar Tarjeta Seleccionada"
    useCardBtn.onclick = function() {
        const selectedCardId = localStorage.getItem('selectedCardId');
        if (selectedCardId) {
            processPaymentWithCard(parseInt(selectedCardId));
            modal.remove();
        }
    };
    
    // Bot√≥n "Agregar Nueva"
    addNewCardBtn.onclick = function() {
        const confirmRedirect = confirm('Ser√°s redirigido a la p√°gina de tarjetas. ¬øDeseas continuar?');
        if (confirmRedirect) {
            modal.remove();
            window.location.href = 'tarjetas.html';
        }
    };
}

// Seleccionar tarjeta
function selectCard(cardId) {
    // Limpiar todas las selecciones
    document.querySelectorAll('.card-option').forEach(card => {
        card.style.borderColor = '#ddd';
        card.style.background = 'white';
    });
    
    document.querySelectorAll('.card-check').forEach(check => {
        check.style.display = 'none';
    });
    
    // Marcar la seleccionada
    const selectedCard = document.querySelector(`[data-id="${cardId}"]`);
    const checkIcon = document.getElementById(`check-${cardId}`);
    
    if (selectedCard) {
        selectedCard.style.borderColor = '#8b0000';
        selectedCard.style.background = '#fff5f5';
        checkIcon.style.display = 'block';
        
        // Guardar en localStorage
        localStorage.setItem('selectedCardId', cardId);
        
        // Mostrar bot√≥n para usar tarjeta
        const useCardBtn = document.getElementById('useSelectedCardBtn');
        useCardBtn.style.display = 'block';
    }
}

// Procesar pago con tarjeta espec√≠fica
async function processPaymentWithCard(cardId) {
    const userId = localStorage.getItem('userId');
    
    if (!userId || !cardId) {
        alert('Error: No se pudo identificar la tarjeta seleccionada');
        return;
    }
    
    try {
        // 1. Obtener informaci√≥n del carrito
        const cartResponse = await fetch(`api.php?action=getCartItems&userId=${userId}`);
        const cartData = await cartResponse.json();
        
        if (!cartData.success || cartData.items.length === 0) {
            alert('Tu carrito est√° vac√≠o');
            return;
        }
        
        // 2. Mostrar confirmaci√≥n
        const total = cartData.total;
        const confirmPayment = confirm(`¬øConfirmar compra por $${total} MXN con la tarjeta seleccionada?`);
        
        if (!confirmPayment) {
            return;
        }
        
        // 3. Mostrar mensaje de procesamiento
        showPaymentProcessingMessage();
        
        // 4. Procesar pago
        const paymentResponse = await fetch('api.php?action=processPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: parseInt(userId),
                cardId: cardId
            })
        });
        
        const paymentResult = await paymentResponse.json();
        
        // 5. Manejar resultado
        handlePaymentResult(paymentResult);
        
    } catch (error) {
        console.error('Error procesando pago:', error);
        alert('Error al procesar el pago. Intenta nuevamente.');
        hidePaymentProcessingMessage();
    }
}

// Mostrar mensaje de procesamiento
function showPaymentProcessingMessage() {
    const processingHTML = `
        <div id="paymentProcessing" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        ">
            <div style="
                background: white;
                padding: 40px;
                border-radius: 8px;
                text-align: center;
                max-width: 400px;
                width: 90%;
            ">
                <div style="
                    width: 60px;
                    height: 60px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #8b0000;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                "></div>
                <h3 style="color: #333; margin-bottom: 10px;">Procesando Pago...</h3>
                <p style="color: #666;">Por favor, espera un momento</p>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', processingHTML);
    
    // Agregar estilo para la animaci√≥n
    if (!document.querySelector('#spinStyle')) {
        const style = document.createElement('style');
        style.id = 'spinStyle';
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
}

// Ocultar mensaje de procesamiento
function hidePaymentProcessingMessage() {
    const processingDiv = document.getElementById('paymentProcessing');
    if (processingDiv) {
        processingDiv.remove();
    }
}

// Manejar resultado del pago
async function handlePaymentResult(result) {
    hidePaymentProcessingMessage();
    
    if (result.success) {
        // Mostrar modal de √©xito
        const successHTML = `
            <div id="paymentSuccessModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 3000;
            ">
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 8px;
                    text-align: center;
                    max-width: 500px;
                    width: 90%;
                ">
                    <div style="
                        width: 80px;
                        height: 80px;
                        background: #4CAF50;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 20px;
                        font-size: 40px;
                        color: white;
                    ">
                        ‚úì
                    </div>
                    <h3 style="color: #333; margin-bottom: 15px;">¬°Pago Exitoso!</h3>
                    <p style="color: #666; margin-bottom: 25px;">
                        Tu compra ha sido procesada correctamente.<br>
                        Total: <strong>$${result.total} MXN</strong>
                    </p>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="viewTicketBtn" style="
                            background: #8b0000;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                        ">
                            Ver Ticket
                        </button>
                        
                        <button id="goToPurchasesBtn" style="
                            background: #f0f0f0;
                            color: #333;
                            border: 1px solid #ddd;
                            padding: 12px 24px;
                            border-radius: 4px;
                            cursor: pointer;
                        ">
                            Ver Mis Compras
                        </button>
                    </div>
                    
                    <p style="margin-top: 20px; color: #888; font-size: 12px;">
                        Se ha enviado un correo de confirmaci√≥n a tu email
                    </p>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', successHTML);
        
        // Configurar eventos del modal de √©xito
        document.getElementById('viewTicketBtn').onclick = function() {
            if (result.ticket_url) {
                window.open(result.ticket_url, '_blank');
            } else {
                generateTicket(result.compraId);
            }
        };
        
        document.getElementById('goToPurchasesBtn').onclick = function() {
            window.location.href = 'compras.html';
        };
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('paymentSuccessModal').onclick = function(e) {
            if (e.target === this) {
                this.remove();
                // Recargar carrito
                loadCartSimple();
            }
        };
        
        // Limpiar tarjeta seleccionada del localStorage
        localStorage.removeItem('selectedCardId');
        
    } else {
        alert('Error en el pago: ' + result.message);
    }
}

// Generar ticket (funci√≥n auxiliar)
async function generateTicket(compraId) {
    const userId = localStorage.getItem('userId');
    
    try {
        const response = await fetch('api.php?action=generateTicket', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                compraId: compraId,
                userId: parseInt(userId)
            })
        });
        
        const result = await response.json();
        
        if (result.success && result.ticket_url) {
            window.open(result.ticket_url, '_blank');
        } else if (result.html) {
            // Mostrar HTML en nueva ventana
            const ticketWindow = window.open('', '_blank');
            ticketWindow.document.write(result.html);
            ticketWindow.document.close();
        } else {
            alert('Ticket generado correctamente. ID de compra: ' + compraId);
        }
    } catch (error) {
        console.error('Error generando ticket:', error);
        alert('Se complet√≥ la compra, pero hubo un error al generar el ticket.');
    }
}
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Carrito page loaded');
            loadCartSimple();
        });
        
        window.removeItem = removeItem;
        window.clearCartSimple = clearCartSimple;
        window.checkoutSimple = checkoutSimple;
    </script>
    <style>
    /* Estilos para el flujo de pago */
    .card-option:hover {
        border-color: #8b0000 !important;
        background: #f9f9f9 !important;
    }
    
    #paymentSuccessModal h3 {
        color: #2e7d32 !important;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        #cardSelectionModal > div {
            width: 95% !important;
            padding: 20px !important;
        }
        
        .card-option {
            padding: 12px !important;
        }
        
        #paymentSuccessModal > div {
            width: 95% !important;
            padding: 20px !important;
        }
        
        #viewTicketBtn, #goToPurchasesBtn {
            padding: 10px 15px !important;
            font-size: 14px !important;
        }
    }
    
    /* Mejoras para la interfaz del carrito */
    #cartContent button {
        transition: all 0.3s ease;
    }
    
    #cartContent button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(139, 0, 0, 0.2);
    }
</style>
</body>
</html>